services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: expense-notes-backend
    restart: unless-stopped
    env_file:
      - ./backend/.env
    volumes:
      - ./backend/data:/app/data
      - ./backend/uploads:/app/uploads
    labels:
      - traefik.enable=true
      - traefik.http.routers.expense-backend.rule=Host(`expenses.hackerspace.gent`) && (PathPrefix(`/api`) || PathPrefix(`/docs`) || PathPrefix(`/openapi.json`))
      - traefik.http.routers.expense-backend.priority=100
      - traefik.http.routers.expense-backend.entrypoints=public
      - traefik.http.routers.expense-backend.tls=true
      - traefik.http.routers.expense-backend.tls.certresolver=letsencrypt
      - traefik.http.services.expense-backend.loadbalancer.server.port=8000
    networks:
      - default

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: https://expenses.hackerspace.gent
    container_name: expense-notes-frontend
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.expense-frontend.rule=Host(`expenses.hackerspace.gent`)
      - traefik.http.routers.expense-frontend.entrypoints=public
      - traefik.http.routers.expense-frontend.tls=true
      - traefik.http.routers.expense-frontend.tls.certresolver=letsencrypt
      - traefik.http.services.expense-frontend.loadbalancer.server.port=80
    networks:
      - default
    depends_on:
      - backend

  hsg-bot:
    build:
      context: ./hsg-bot
      dockerfile: Dockerfile
    container_name: hsg-bot
    restart: unless-stopped
    env_file:
      - ./hsg-bot/.env
    dns:
      - 8.8.8.8
      - 1.1.1.1
    labels:
      - traefik.enable=true
      - traefik.http.routers.hsg-bot.rule=Host(`expenses.hackerspace.gent`) && PathPrefix(`/bot`)
      - traefik.http.routers.hsg-bot.entrypoints=public
      - traefik.http.routers.hsg-bot.tls=true
      - traefik.http.routers.hsg-bot.tls.certresolver=letsencrypt
      - traefik.http.services.hsg-bot.loadbalancer.server.port=5000
      - traefik.http.middlewares.hsg-bot-stripprefix.stripprefix.prefixes=/bot
      - traefik.http.routers.hsg-bot.middlewares=hsg-bot-stripprefix
    networks:
      - default

networks:
  default:
    external: true
    name: traefik_public
